#!/bin/bash

set -e

DIR="$(dirname "$0")/../"

function use_version() {
    nvm_script="$HOME/.nvm/nvm.sh"
    if [ ! -f "$nvm_script" ]; then
        echo "nvm script not found at $nvm_script. Is nvm installed?"
        exit 1
    fi
    source ~/.nvm/nvm.sh
    if ! nvm list | grep -q "$(cat .nvmrc)"; then
        nvm install "$(cat .nvmrc)"
    fi
    nvm use

    yvm_script="$HOME/.yvm/yvm.sh"
    if [ ! -f $yvm_script ]; then
        echo "yvm script not found at $yvm_script. Is yvm installed?"
        exit 1
    fi
    source ~/.yvm/yvm.sh
    yvm use
}

function usage() {
    echo -n \
        "Usage: $(basename "$0")
Setup external project dependencies.
"
}

if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    if [ "${1:-}" = "--help" ]; then
        usage
    else
        use_version

        pushd "${DIR}/src/server"
        echo "Updating server dependencies"
        yarn install
        popd

        echo "Running database migrations"
        ./scripts/migrate

        echo "Updating client dependencies"
        yarn install
    fi
fi
